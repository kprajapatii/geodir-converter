!function(e,t){"use strict";t.ajax=function(n,i,o,r){r=void 0!==r?r:{},o=void 0!==o?o:{};const s=t.nonces.hasOwnProperty(n)?t.nonces[n]:"";return o instanceof FormData?(o.append("action",n),o.append("geodir_converter_nonce",s),r.processData=!1,r.contentType=!1):(o.action=n,o.geodir_converter_nonce=s),r=e.extend(r,{url:t.ajaxUrl,dataType:"json",data:o,success:function(e){const t=!0===e.success,n=e.data||{};i(t,n)}}),e.ajax(r)},t.ControlButton={inSuspended:!1,wasDisabled:!1,defaultText:"",actionText:"",ajaxAction:"",converter:null,init:function(e,t){return this.element=e,this.defaultText=t.defaultText,this.actionText=t.actionText,this.ajaxAction=t.ajaxAction,this.converter=t.converter,this.element.on("click",this.click.bind(this)),this},click:function(){if(this.inSuspended)return!1;this.doAction()},doAction:function(){},activate:function(){this.inSuspended=!0,this.element.prop("disabled",!0),this.element.text(this.actionText)},enable:function(){this.inSuspended=!1,this.element.prop("disabled",!1),this.element.text(this.defaultText)},disable:function(){this.inSuspended=!1,this.element.prop("disabled",!0),this.element.text(this.defaultText)},suspend:function(){this.inSuspended=!0,this.wasDisabled=!!this.element.prop("disabled"),this.element.prop("disabled",!0)},restore:function(){this.inSuspended=!1,this.element.prop("disabled",this.wasDisabled)}},t.ImportButton=e.extend({},t.ControlButton,{doAction:function(){const e=this,n=this.converter.importerId,i=this.converter.errorHandler,o=this.converter.settings.find("form"),r=this.converter.files,s=o.serializeObject(),a=o.find("#test_mode").is(":checked")?"yes":"no",l=new FormData;if(n){if(l.append("test_mode",a),l.append("importerId",n),l.append("settings",JSON.stringify(s)),r.length>0)for(let e=0;e<r.length;e++)l.append("files[]",r[e]);this.activate(),i.hide(),t.ajax(e.ajaxAction,(function(t,n){t?e.converter.start():(e.enable(),e.converter.stop(),i.show(n.message))}),l,{method:"POST",contentType:!1,processData:!1})}}}),t.ConfigureButton=e.extend({},t.ControlButton,{activate:function(){this.element.addClass("btn-translucent-success").removeClass("btn-outline-primary").text(this.actionText)},enable:function(){this.element.addClass("btn-outline-primary").removeClass("btn-translucent-success").text(this.defaultText)},doAction:function(){const n=e(".geodir-converter-wrapper"),i=this.converter.element,o=this.converter.settings;n.find(".card-header h6").text(t.i18n.importSource),n.find(".geodir-converter-importer").not(i).addClass("d-none"),e(".geodir-converter-settings").not(o).addClass("d-none"),this.element.addClass("d-none"),this.converter.backButton.element.removeClass("d-none"),i.addClass("border-bottom-0"),o.removeClass("d-none")}}),t.BackButton=e.extend({},t.ControlButton,{doAction:function(){const n=e(".geodir-converter-wrapper"),i=this.converter.element,o=this.converter.settings;this.element.addClass("d-none"),this.converter.configureButton.element.removeClass("d-none"),i.removeClass("border-bottom-0"),o.addClass("d-none"),n.find(".card-header h6").text(t.i18n.selectImport),n.find(".geodir-converter-importer").removeClass("d-none"),o.find("form").length&&(o.find("form")[0].reset(),this.converter.errorHandler.clear())}}),t.AbortButton=e.extend({},t.ControlButton,{doAction:function(){this.activate(),this.converter.stop();const e=this.converter.importerId,n=this;t.ajax(n.ajaxAction,(function(e,t){n.converter.start(),e||n.enable()}),{importerId:e},{method:"POST"})}}),t.LogsHandler=e.extend({},{shown:0,userInteracting:!1,interactionTimeout:null,init:function(e){var t=this;return this.element=e,this.element.length&&this.element[0]?(this.element.scrollTop(this.element[0].scrollHeight),this.element.on("mouseenter",(function(){t.userInteracting=!0})),this.element.on("mouseleave",(function(){clearTimeout(t.interactionTimeout),t.interactionTimeout=setTimeout((function(){t.userInteracting=!1}),1e3)})),this.element.on("wheel scroll touchstart",(function(){if(t.element.length&&t.element[0]){t.userInteracting=!0,clearTimeout(t.interactionTimeout);var e=t.element[0],n=Math.abs(e.scrollHeight-e.clientHeight-e.scrollTop)<5;t.interactionTimeout=n?setTimeout((function(){t.userInteracting=!1}),500):setTimeout((function(){t.userInteracting=!1}),3e3)}})),this):this},insertLogs:function(e){this.element.length&&this.element[0]&&(this.element.append(e),this.userInteracting||this.element.scrollTop(this.element[0].scrollHeight))},setShown:function(e){this.shown=e},clear:function(){this.shown=0,this.userInteracting=!1,clearTimeout(this.interactionTimeout),this.element.length&&this.element.html("")}}),t.ErrorHandler={init:function(e){return this.element=e,this},show:function(e){this.element.html(e).removeClass("d-none")},hide:function(){this.element.html("").addClass("d-none")},clear:function(){this.hide()},isVisible:function(){return!this.element.hasClass("d-none")}},t.ProgressBar=e.extend({},{barEl:null,init:function(e){return this.element=e,this.barEl=this.element.find(".progress-bar"),this},updateProgress:function(e){this.element.removeClass("d-none"),this.barEl.css("width",e+"%").text(e+"%")}}),t.DropZone=e.extend({},{dropzone:null,input:null,btn:null,uploads:null,init:function(e,t){this.element=e,this.converter=t.converter,this.dropzone=this.element.find(".geodir-converter-drop-zone"),this.btn=this.element.find(".geodir-converter-files-btn"),this.input=this.element.find(".geodir-converter-files-input"),this.uploads=this.element.find(".geodir-converter-uploads");const n=this;return this.disableStep2Inputs(!0),this.btn.on("click",(function(){n.input.trigger("click")})),this.dropzone.on("dragover dragenter",(function(e){e.preventDefault(),e.stopPropagation(),n.dropzone.addClass("dragover")})),this.dropzone.on("dragleave dragend drop",(function(e){e.preventDefault(),e.stopPropagation(),n.dropzone.removeClass("dragover")})),this.dropzone.on("drop",(function(e){n.handleFiles(e.originalEvent.dataTransfer.files)})),this.input.on("change",(function(e){e.preventDefault(),n.handleFiles(this.files)})),this},handleFiles:function(e){const t=this,n="csv"===(this.converter?this.converter.importerId:"edirectory");Array.from(e).forEach((function(e){e.name.toLowerCase().endsWith(".csv")||e.name.toLowerCase().endsWith(".txt")||!n?t.uploadFile(e):aui_toast("geodir_converter_error","error",`${e.name} is not a CSV file.`)}))},uploadFile:function(e){const t=this.converter?this.converter.importerId:"edirectory",n=this._createUploadContext(e,t);"csv"===t?this._uploadCSVFile(n):this._uploadEDirectoryFile(n)},_createUploadContext:function(n,i){const o="upload-"+Date.now(),r=this.renderUploadItem(o,n.name),s=e.extend({},t.ProgressBar).init(r.find(".progress"));return{file:n,fileId:o,item:r,progress:s,status:r.find(".geodir-converter-progress-status"),icon:r.find(".geodir-converter-progress-icon"),importerId:i}},_uploadCSVFile:function(e){const n=this,i=this._buildCSVFormData(e.file);t.ajax(t.actions.csv_parse,(function(t,i){n._handleUploadResponse(t,i,e,(function(){if(i.file_id){const e=n.element.find("#csv_delimiter").val()||",";n.converter.switchToCSVMappingStep({file_id:i.file_id,delimiter:e,headers:i.headers||[]})}}))}),i,this._getUploadAjaxOptions(e))},_uploadEDirectoryFile:function(n){const i=this,o=this._buildEDirectoryFormData(n.file,n.importerId),r=this.element.find('[name="edirectory_modules[]"]');t.ajax(t.actions.upload,(function(t,o){i._handleUploadResponse(t,o,n,(function(){if(o.module_type){const t=r.map((function(){return e(this).val()})).get();if(!t.includes(o.module_type)){t.push(o.module_type),r.remove();const e=t.map((function(e){return'<input type="hidden" name="edirectory_modules[]" value="'+e+'">'})).join("");i.element.append(e)}}}))}),o,this._getUploadAjaxOptions(n))},_buildCSVFormData:function(e){const t=new FormData;t.append("file",e),t.append("importerId","csv");const n=this.element.find("#csv_delimiter").val()||",";t.append("csv_delimiter",n);const i=this.element.find('select[name="gd_post_type"]').val();return i&&t.append("gd_post_type",i),t},_buildEDirectoryFormData:function(e,t){const n=new FormData;return n.append("file",e),n.append("importerId",t),n},_getUploadAjaxOptions:function(e){const n=this,i=e.progress,o=e.icon,r=e.status;return{method:"POST",xhr:function(){const e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);i.updateProgress(t)}}),!1),e},error:function(){i.barEl.removeClass("progress-bar-animated").addClass("bg-danger"),o.removeClass("fa-sync").addClass("fa-triangle-exclamation text-danger"),r.text(t.i18n.serverErrorUpload),n.disableStep2Inputs(!0)}}},_handleUploadResponse:function(e,n,i,o){const r=i.progress,s=i.icon,a=i.status,l=i.file;r.barEl.removeClass("progress-bar-animated"),s.removeClass("fa-sync"),e?(r.barEl.addClass("bg-success"),s.addClass("fa-check text-success"),a.text(n.message||t.i18n.fileUploadSuccess),this.converter.files.some((function(e){return e.name===l.name&&e.size===l.size&&e.lastModified===l.lastModified}))||this.converter.files.push(l),o&&o(),this.disableStep2Inputs(!1)):(r.barEl.addClass("bg-danger"),s.addClass("fa-triangle-exclamation text-danger"),a.text(t.i18n.uploadFailed+(n.message||t.i18n.unknownError)),this.disableStep2Inputs(!0))},disableStep2Inputs:function(e){const t=this.element.find(".geodir-converter-configure-wrapper");t.length&&t.find("input, select, textarea, button").not('[name="edirectory_modules[]"]').prop("disabled",e)},renderUploadItem:function(n,i){const o=e(`\n                <div class="upload-item my-2" data-id="${n}">\n                    <div class="d-flex justify-content-between align-items-center">\n                        <span class="fw-bold text-truncate">${i}</span>\n                        <i class="fas fa-solid fa-sync text-muted ms-2 geodir-converter-progress-icon" aria-hidden="true"></i>\n                    </div>\n                    <div class="progress my-1 d-none" role="progressbar" aria-valuemin="0" aria-valuemax="100">\n                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>\n                    </div>\n                    <div class="geodir-converter-progress-status small text-muted mt-1">${t.i18n.uploading}</div>\n                </div>\n            `);return this.uploads.append(o),this.uploads.find(`[data-id="${n}"]`)}}),t.Converter={tickInterval:2e3,shortTickInterval:400,retriesCount:1,retriesLeft:0,inProgress:!1,updateTimeout:null,preventUpdates:!1,importerId:null,files:[],init:function(n,i){this.element=n,this.inProgress=i.inProgress,this.resetRetries(),this.importerId=this.element.data("importer"),this.settings=this.element.find(".geodir-converter-settings");let o=e.extend({},t.ProgressBar);this.progressBar=o.init(this.element.find(".geodir-converter-progress"));let r=e.extend({},t.LogsHandler);this.logsHandler=r.init(this.element.find(".geodir-converter-logs"));let s=e.extend({},t.ConfigureButton);this.configureButton=s.init(this.element.find(".geodir-converter-configure"),{defaultText:t.i18n.runConverter,actionText:t.i18n.importing,converter:this});let a=e.extend({},t.BackButton);this.backButton=a.init(this.element.find(".geodir-converter-back"),{converter:this});let l=e.extend({},t.ImportButton);this.importButton=l.init(this.element.find(".geodir-converter-import"),{defaultText:t.i18n.import,actionText:t.i18n.importing,ajaxAction:t.actions.import,converter:this});let c=e.extend({},t.AbortButton);this.abortButton=c.init(this.element.find(".geodir-converter-abort"),{defaultText:t.i18n.abort,actionText:t.i18n.aborting,ajaxAction:t.actions.abort,converter:this});let d=e.extend({},t.ErrorHandler);this.errorHandler=d.init(this.element.find(".geodir-converter-error"),{converter:this});const p=this.element.find(".geodir-converter-connect-wrapper");if(p.length){let n=e.extend({},t.DropZone);this.dropZone=n.init(p,{converter:this})}return this.inProgress&&this.start(),this.element.data("converter",this),this},switchToCSVMappingStep:function(n){const i=this.element.find(".geodir-converter-csv-form");i.length&&t.ajax(t.actions.csv_get_mapping_step,function(n,o){if(!n)return void alert(o.message||t.i18n.failedLoadMapping);const r=e(o.html);i.html(r.html()),this._initializeMappingStepButtons(i)}.bind(this),{file_id:n.file_id,delimiter:n.delimiter||","},{method:"POST"})},_initializeMappingStepButtons:function(n){const i=n.find(".geodir-converter-import"),o=n.find(".geodir-converter-abort");if("function"==typeof aui_init_select2&&aui_init_select2(),i.length){const n=e.extend({},t.ImportButton);this.importButton=n.init(i,{defaultText:t.i18n.import,actionText:t.i18n.importing,ajaxAction:t.actions.import,converter:this})}if(o.length){const n=e.extend({},t.AbortButton);this.abortButton=n.init(o,{defaultText:t.i18n.abort,actionText:t.i18n.aborting,ajaxAction:t.actions.abort,converter:this})}},start:function(){this.preventUpdates=!1,this.logsHandler.clear(),this.updateTimeout=setTimeout(this.tick.bind(this),this.shortTickInterval)},stop:function(){clearTimeout(this.updateTimeout),this.preventUpdates=!0},resetRetries:function(){this.retriesLeft=this.retriesCount},tick:function(){const e=this;t.ajax(t.actions.progress,(function(t,n){e.preventUpdates||(t?(e.resetRetries(),n.inProgress?e.markInProgress():e.markStopped(),n.inProgress?e.configureButton.activate():e.configureButton.enable(),e.progressBar.updateProgress(n.progress),e.logsHandler.setShown(n.logsShown),e.logsHandler.insertLogs(n.logs),e.dropZone&&e.dropZone.btn&&e.dropZone.btn.prop("disabled",n.inProgress),e.inProgress?e.updateTimeout=setTimeout(e.tick.bind(e),e.tickInterval):(e.abortButton.disable(),e.importButton.enable())):e.retriesLeft>0?(e.retriesLeft--,e.updateTimeout=setTimeout(e.tick.bind(e),e.tickInterval)):e.abortButton.disable())}),{logsShown:e.logsHandler.shown,importerId:this.importerId})},markInProgress:function(){this.inProgress=!0,this.importButton.activate(),this.abortButton.enable()},markStopped:function(){this.inProgress=!1,this.importButton.enable(),this.abortButton.disable()}},t.CSVImporter={init:function(){const t=this;e(".geodir-converter-csv-form").length&&("function"==typeof aui_init_select2&&aui_init_select2(),e(document).on("click",".geodir-converter-csv-back",(function(e){e.preventDefault(),t.goBack()})),e(document).on("click",".geodir-converter-refresh-fields",(function(e){e.preventDefault(),t.refreshFields()})),e(document).on("change",'.geodir-converter-csv-form select[name="gd_post_type"]',(function(){t.refreshFields()})),e(document).on("click",".geodir-converter-save-template",(function(e){e.preventDefault(),t.saveTemplate()})),e(document).on("click",".geodir-converter-load-template",(function(e){e.preventDefault(),t.loadTemplate()})),e(document).on("click",".geodir-converter-delete-template",(function(e){e.preventDefault(),t.deleteTemplate()})))},refreshFields:function(){const n=e(".geodir-converter-csv-form").find('select[name="gd_post_type"]').val(),i=e("#geodir-converter-csv-mapping-wrapper"),o=e(".geodir-converter-refresh-fields");n&&(o.prop("disabled",!0).find("i").addClass("fa-spin"),t.ajax(t.actions.csv_refresh_fields,(function(e,n){o.prop("disabled",!1).find("i").removeClass("fa-spin"),e?(i.html(n.html),"function"==typeof aui_init_select2&&aui_init_select2()):i.html('<div class="alert alert-danger">'+(n.message||t.i18n.failedRefreshFields)+"</div>")}),{gd_post_type:n},{method:"POST"}))},goBack:function(){const n=e(".geodir-converter-csv-form"),i=n.closest(".geodir-converter-importer"),o=i.length?i.data("converter"):null,r=e(".geodir-converter-csv-back"),s=r.html(),a=r.prop("disabled");r.prop("disabled",!0),r.html('<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>'+t.i18n.loading),t.ajax(t.actions.csv_clear_file,(function(i,l){if(r.prop("disabled",a),r.html(s),!i)return void alert(l.message||t.i18n.failedClearFile);const c=e(l.html);if(n.html(c.html()),o){const i=n.find(".geodir-converter-connect-wrapper");if(i.length){const n=e.extend({},t.DropZone);o.dropZone=n.init(i,{converter:o})}}"function"==typeof aui_init_select2&&aui_init_select2()}),{},{method:"POST"})},saveTemplate:function(){const n=e(".geodir-converter-csv-form"),i=e("#csv_template_name"),o=i.val().trim(),r=e(".geodir-converter-save-template");if(!o)return aui_toast("geodir_converter_error","error",t.i18n.templateNameRequired),void i.focus();const s={};n.find("select.geodir-converter-field-mapping").each((function(){const t=e(this),n=t.attr("name").replace("csv_mapping[","").replace("]",""),i=t.val();i&&(s[n]=i)})),0!==Object.keys(s).length?(r.prop("disabled",!0),t.ajax(t.actions.csv_save_template,(function(e,n){r.prop("disabled",!1),e?(i.val(""),aui_toast("geodir_converter_success","success",n.message||t.i18n.templateSaved),self.refreshTemplateList(n.template_id,n.template_name)):aui_toast("geodir_converter_error","error",n.message||t.i18n.templateSaveFailed)}),{template_name:o,csv_mapping:s},{method:"POST"})):aui_toast("geodir_converter_error","error",t.i18n.templateMappingRequired)},loadTemplate:function(){const n=e("#csv_template_select").val(),i=e(".geodir-converter-load-template");n?(i.prop("disabled",!0),t.ajax(t.actions.csv_load_template,(function(n,o){if(i.prop("disabled",!1),n){const n=e(".geodir-converter-csv-form"),i=o.mapping||{};Object.keys(i).forEach((function(e){const t=i[e],o=n.find('select[name="csv_mapping['+e+']"]');o.length&&(o.val(t),o.hasClass("select2-hidden-accessible")&&o.data("select2")?o.trigger("change.select2"):o.trigger("change"))})),setTimeout((function(){"function"==typeof aui_init_select2&&aui_init_select2(),n.find(".geodir-converter-field-mapping").each((function(){const t=e(this);t.hasClass("select2-hidden-accessible")&&t.trigger("change.select2")}))}),150),aui_toast("geodir_converter_success","success",o.message||t.i18n.templateLoaded)}else aui_toast("geodir_converter_error","error",o.message||t.i18n.templateLoadFailed)}),{template_id:n},{method:"POST"})):aui_toast("geodir_converter_error","error",t.i18n.templateSelectRequired)},deleteTemplate:function(){const n=e("#csv_template_select"),i=n.val(),o=e(".geodir-converter-delete-template");i?confirm(t.i18n.templateDeleteConfirm)&&(o.prop("disabled",!0),t.ajax(t.actions.csv_delete_template,(function(e,r){if(o.prop("disabled",!1),e){n.find('option[value="'+i+'"]').data("name");n.val("").find('option[value="'+i+'"]').remove(),n.find("option").length<=1&&self.hideTemplateLoadSection(),aui_toast("geodir_converter_success","success",r.message||t.i18n.templateDeleted)}else aui_toast("geodir_converter_error","error",r.message||t.i18n.templateDeleteFailed)}),{template_id:i},{method:"POST"})):aui_toast("geodir_converter_error","error",t.i18n.templateSelectRequired)},refreshTemplateList:function(n,i){let o=e("#csv_template_select");const r=e(".geodir-converter-templates-section").find(".row");let s=e(".geodir-converter-template-load-section");if(s.length){if(s.hasClass("d-none")){s.removeClass("d-none");const t=e(".geodir-converter-template-save-section");t.length&&t.removeClass("col-12").addClass("col-md-6")}}else{const n=e(".geodir-converter-template-save-section"),i=e("<div>",{class:"col-md-6 geodir-converter-template-load-section",html:'<label class="form-label mb-2">'+t.i18n.loadTemplate+'</label><div class="input-group"><select class="form-select form-select-sm" id="csv_template_select"><option value="">'+t.i18n.chooseTemplate+'</option></select><button type="button" class="btn btn-sm btn-primary geodir-converter-load-template" title="'+t.i18n.loadSelectedTemplate+'"><i class="fas fa-arrow-down"></i></button><button type="button" class="btn btn-sm btn-outline-danger geodir-converter-delete-template" title="'+t.i18n.deleteSelectedTemplate+'"><i class="fas fa-trash-alt"></i></button></div>'});n.length?(n.before(i),n.removeClass("col-12").addClass("col-md-6")):r.prepend(i),o=e("#csv_template_select"),s=e(".geodir-converter-template-load-section")}if(n&&i){const t=e("<option>",{value:n,text:i,"data-name":i});o.append(t),o.val(n),o.hasClass("select2-hidden-accessible")&&o.trigger("change.select2")}"function"==typeof aui_init_select2&&aui_init_select2()},hideTemplateLoadSection:function(){const t=e(".geodir-converter-template-load-section");if(t.length){t.addClass("d-none");const n=e(".geodir-converter-template-save-section");n.length&&n.removeClass("col-md-6").addClass("col-12")}}},e((function(){e(".geodir-converter-importer").each((function(){e.extend({},t.Converter).init(e(this),{inProgress:Boolean(e(this).data("progress"))})})),t.CSVImporter.init()})),e.fn.serializeObject=function(){let t={},n=this.serializeArray();return e.each(n,(function(){let e=this.name.replace(/\[\]$/,""),n=this.value||"";if(e.indexOf("[")>-1){let i=e.split("["),o=i[0],r=i[1].replace(/\]$/,"");t[o]=t[o]||{},t[o][r]=n}else t[e]=n})),t}}(jQuery,GeoDir_Converter);